<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- PWA / iOS -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">

  <!-- Viewport: landscape-friendly with safe areas -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">

  <title>Terranium</title>

  <style>
    :root {
      color-scheme: dark;
      --bg: #000;
      --fg: #fff;
      --accent: #7fd1ff;
    }
    html, body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    }
    /* Fullscreen canvas or app container goes here */
    #app { position: fixed; inset: 0; }

    /* Rotate overlay (shown in portrait) */
    #rotateOverlay {
      position: fixed;
      inset: env(safe-area-inset-top) env(safe-area-inset-right)
            env(safe-area-inset-bottom) env(safe-area-inset-left);
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      backdrop-filter: blur(6px);
      background: rgba(0,0,0,0.85);
      z-index: 99999;
      padding: 24px;
    }
    #rotateCard {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      border-radius: 16px;
      padding: 24px 28px;
      background: linear-gradient(180deg, #0c0f13 0%, #0a0c10 100%);
      box-shadow: 0 10px 40px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.06);
    }
    #rotateCard svg { width: 84px; height: 84px; opacity: .9; }
    #rotateCard h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.3px;
      font-weight: 600;
    }
    #rotateCard p {
      margin: 0;
      opacity: .8;
      max-width: 22em;
      line-height: 1.35;
      font-size: 14px;
    }

    /* Minimal error overlay for debugging */
    #errorOverlay {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.92);
      color: #ff6;
      font: 14px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space: pre-wrap;
      padding: 12px;
      display: none;
      z-index: 100000;
      overflow: auto;
    }
  </style>
</head>
<body>
  <div id="app"><!-- your app mounts here (canvas, etc.) --></div>

  <!-- Rotate-to-landscape overlay -->
  <div id="rotateOverlay" aria-hidden="true">
    <div id="rotateCard">
      <!-- phone icon that rotates hint -->
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#7fd1ff"/>
            <stop offset="1" stop-color="#3aa2ff"/>
          </linearGradient>
        </defs>
        <g fill="none" stroke="url(#g)" stroke-width="2">
          <rect x="13" y="8" rx="6" ry="6" width="38" height="48" />
          <path d="M9 22c-4 7-4 13 0 20" stroke-linecap="round"/>
          <path d="M55 22c4 7 4 13 0 20" stroke-linecap="round"/>
          <path d="M23 12h18M23 52h18" opacity=".6"/>
        </g>
      </svg>
      <h1>Rotate to Landscape</h1>
      <p>For the best experience, please rotate your device to landscape.</p>
    </div>
  </div>

  <div id="errorOverlay"></div>

  <!-- Your main app script(s) here -->
  <!-- Example: <script type="module" src="./src/main.js"></script> -->

  <script>
    /* ---------- Error overlay ---------- */
    const errorOverlay = document.getElementById('errorOverlay');
    function showError(msg, src, line, col, err){
      errorOverlay.style.display='block';
      errorOverlay.textContent = '⚠️ JS Error:\\n' + msg +
        (src?('\\n\\nSource: '+src+':'+line+':'+col):'') +
        (err && err.stack?('\\n\\n'+err.stack):'');
      console.error(msg, err);
    }
    window.addEventListener('error', e => showError(e.message, e.filename, e.lineno, e.colno, e.error));
    window.addEventListener('unhandledrejection', e => showError(e.reason?.message || e.reason, '', '', '', e.reason));
  </script>

  <script>
    /* ---------- Rotate-to-landscape logic ---------- */
    const rotateOverlay = document.getElementById('rotateOverlay');
    const isLandscape = () => {
      // Fallbacks for older iOS:
      if (screen.orientation && 'type' in screen.orientation) {
        return screen.orientation.type.startsWith('landscape');
      }
      return window.innerWidth >= window.innerHeight;
    };
    function updateRotateOverlay(){
      rotateOverlay.style.display = isLandscape() ? 'none' : 'flex';
    }
    window.addEventListener('resize', updateRotateOverlay);
    window.addEventListener('orientationchange', updateRotateOverlay);
    updateRotateOverlay();

    // Try to lock landscape at runtime (best effort)
    (async () => {
      if (screen.orientation?.lock) {
        try { await screen.orientation.lock('landscape'); } catch {}
      }
    })();
  </script>

  <script>
    /* ---------- Generate app icons in code ---------- */

    // 1) SVG icon as a data URL (for modern browsers / manifest consumers)
    const svgIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
        <defs>
          <linearGradient id="bg" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#10131a"/>
            <stop offset="1" stop-color="#05070b"/>
          </linearGradient>
          <linearGradient id="ring" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#7fd1ff"/>
            <stop offset="1" stop-color="#3aa2ff"/>
          </linearGradient>
        </defs>
        <rect width="512" height="512" rx="96" fill="url(#bg)"/>
        <!-- stylized pad / tower mark -->
        <g transform="translate(256,256)">
          <circle r="160" fill="none" stroke="url(#ring)" stroke-width="22" opacity=".9"/>
          <rect x="-42" y="-118" width="84" height="236" rx="14" fill="#e6eef7" opacity=".95"/>
          <rect x="-84" y="68" width="168" height="26" rx="13" fill="#3aa2ff"/>
          <rect x="-70" y="-18" width="140" height="18" rx="9" fill="#7fd1ff" opacity=".85"/>
          <rect x="-70" y="-52" width="140" height="18" rx="9" fill="#7fd1ff" opacity=".70"/>
        </g>
      </svg>
    `.trim();

    // Helper to make a <link rel="icon" …> for SVG
    (function attachSvgFavicon(){
      const link = document.createElement('link');
      link.rel = 'icon';
      link.type = 'image/svg+xml';
      link.href = 'data:image/svg+xml;utf8,' + encodeURIComponent(svgIcon);
      document.head.appendChild(link);
    })();

    // 2) Create an Apple Touch Icon at runtime (PNG), since iOS prefers PNG
    (async function makeAppleTouchIcon(){
      try {
        const size = 512; // good for iOS
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');

        // Draw the SVG into the canvas
        const img = new Image();
        img.decoding = 'sync';
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgIcon);
        await img.decode();
        ctx.drawImage(img, 0, 0, size, size);

        const pngUrl = canvas.toDataURL('image/png');

        // Apple touch icon
        const touch = document.createElement('link');
        touch.rel = 'apple-touch-icon';
        touch.href = pngUrl;
        document.head.appendChild(touch);

        // Also add a high-res PNG favicon for good measure
        const favPng = document.createElement('link');
        favPng.rel = 'icon';
        favPng.type = 'image/png';
        favPng.sizes = '512x512';
        favPng.href = pngUrl;
        document.head.appendChild(favPng);
      } catch (e) {
        console.warn('Could not generate Apple Touch Icon:', e);
      }
    })();
  </script>

  <script>
    /* ---------- SW: unregister legacy, clear caches, register network-only SW ---------- */
    (async () => {
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
      } catch (e) { console.warn('SW unregister failed:', e); }

      try {
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map(n => caches.delete(n)));
        }
      } catch (e) { console.warn('Cache clear failed:', e); }

      if ('serviceWorker' in navigator) {
        try {
          await navigator.serviceWorker.register('./sw.js', { scope: './' });
        } catch (err) {
          console.warn('SW register failed:', err);
        }
      }
    })();
  </script>
</body>
</html>